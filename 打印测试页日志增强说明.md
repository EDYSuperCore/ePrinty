# 打印测试页功能日志增强说明

## 修改概述

本次修改增强了"打印测试页"功能的可观测性，在所有关键步骤添加了详细日志，并统一了错误返回格式。

## 修改文件清单

1. `src-tauri/src/main.rs` - Command 入口日志
2. `src-tauri/src/platform/windows/test_page.rs` - 完整步骤日志
3. `src-tauri/src/platform/windows/ps.rs` - PowerShell 执行日志

## 详细修改内容

### 1. Command 入口日志 (`main.rs:532`)

**添加内容**：
- 打印接收到的 `printer_name` 参数
- JSON 风格转义（显示控制字符、引号、反斜杠）
- 显示字符串长度和字节长度
- 统一错误格式：`[PrintTestPage] ERROR step=VALIDATE message=...`

**日志示例**：
```
[Command] print_test_page received printer_name="大厦A座三楼打印机" len=9 bytes=27
```

### 2. Windows 实现步骤日志 (`test_page.rs`)

#### 2.1 START 步骤
- 打印函数入口和打印机名称

#### 2.2 CHECK_EXISTS 步骤
- 打印执行的 PowerShell 脚本
- 打印检查结果（exists、exit_code、stdout）

#### 2.3 GEN_CONTENT 步骤
- 打印内容生成开始
- 打印生成的内容长度（字节数）

#### 2.4 TEMP_FILE_CREATE 步骤
- 打印临时文件路径
- 打印文件大小
- 打印前 16 字节的十六进制（用于验证 UTF-8 BOM）
- 打印文件是否存在

#### 2.5 PS_PRIMARY_SCRIPT 步骤
- 打印完整 PowerShell 脚本（多行版本）
- 打印单行版本（便于复制到 PowerShell 手动执行）

#### 2.6 PS_PRIMARY_RESULT 步骤
- 打印 exit_code
- 打印 stdout 和 stderr 长度
- 打印 stdout 和 stderr 内容（超过 4KB 时截断）

#### 2.7 FALLBACK_TO_CIM 步骤
- 打印触发备选方案的原因

#### 2.8 PS_FALLBACK_SCRIPT + RESULT 步骤
- 打印备选 PowerShell 脚本（多行和单行）
- 打印执行结果（exit_code、stdout、stderr）

#### 2.9 TEMP_FILE_DELETE 步骤
- 打印删除结果（成功/失败）
- 调试模式下保留文件并提示

#### 2.10 SUCCESS 步骤
- 打印成功信息

### 3. PowerShell 执行日志 (`ps.rs:33`)

**添加内容**：
- 打印脚本长度和超时时间
- 打印 PowerShell 启动参数
- 打印进程 ID
- 打印进程完成时间和退出码
- 打印超时触发详情（如果发生）
- 打印最终输出长度

### 4. 错误返回格式统一

所有 `Err` 返回都使用统一格式：
```rust
Err(format!("[PrintTestPage] ERROR step={STEP} message={DETAIL}"))
```

**Step 标识列表**：
- `VALIDATE` - 参数校验失败
- `CHECK_EXISTS` - 打印机存在性检查失败
- `TEMP_FILE_CREATE` - 临时文件创建失败
- `PS_PRIMARY_EXEC` - 主要 PowerShell 命令执行失败
- `PS_FALLBACK_EXEC` - 备选 PowerShell 命令执行失败
- `PS_PRIMARY_RESULT` - 主要命令返回错误
- `PS_FALLBACK_RESULT` - 备选命令返回错误

### 5. 调试开关：临时文件保留

**环境变量**：`EPRINTY_DEBUG_KEEP_TESTPAGE_FILE=1`

**行为**：
- 设置后，临时文件不会被删除
- 日志中会明确提示："已保留文件用于排查：path=..."
- 默认行为：删除临时文件

**使用方法**：
```powershell
# Windows PowerShell
$env:EPRINTY_DEBUG_KEEP_TESTPAGE_FILE="1"
# 然后运行应用
```

## 日志输出示例

### 成功场景
```
[Command] print_test_page received printer_name="大厦A座三楼打印机" len=9 bytes=27
[PrintTestPage] START printer_name="大厦A座三楼打印机"
[PrintTestPage] CHECK_EXISTS script="Get-Printer -Name '大厦A座三楼打印机' -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Name"
[PowerShell] START script_len=... timeout_secs=120
[PowerShell] ARGS: powershell -NoProfile -NonInteractive -WindowStyle Hidden -Command <script>
[PowerShell] SPAWN_SUCCESS pid=12345
[PowerShell] PROCESS_COMPLETE exit_code=Some(0) elapsed_secs=0.52
[PowerShell] SUCCESS exit_code=Some(0) stdout_len=27 stderr_len=0
[PrintTestPage] CHECK_EXISTS result exists=true exit_code=Some(0) stdout="大厦A座三楼打印机"
[PrintTestPage] GEN_CONTENT start
[PrintTestPage] GEN_CONTENT result content_len=1234 bytes
[PrintTestPage] TEMP_FILE_CREATE path="C:\Users\...\AppData\Local\Temp\printer_test_12345.txt"
[PrintTestPage] TEMP_FILE_CREATE result size=1237 bytes first_16_bytes_hex="ef bb bf 0d 0a 3d 3d 3d 3d 3d 3d 3d 3d 3d 3d 3d" exists=true
[PrintTestPage] PS_PRIMARY_SCRIPT (multiline):
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; ...
[PrintTestPage] PS_PRIMARY_SCRIPT (single_line): "[Console]::OutputEncoding = ..."
[PowerShell] START script_len=... timeout_secs=120
...
[PrintTestPage] PS_PRIMARY_RESULT exit_code=Some(0) stdout_len=7 stderr_len=0
[PrintTestPage] PS_PRIMARY_RESULT stdout="Success"
[PrintTestPage] PS_PRIMARY_RESULT stderr=""
[PrintTestPage] TEMP_FILE_DELETE success path="C:\Users\...\AppData\Local\Temp\printer_test_12345.txt"
[PrintTestPage] SUCCESS printer_name="大厦A座三楼打印机"
```

### 失败场景
```
[Command] print_test_page received printer_name="不存在的打印机" len=7 bytes=21
[PrintTestPage] START printer_name="不存在的打印机"
[PrintTestPage] CHECK_EXISTS script="Get-Printer -Name '不存在的打印机' -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Name"
...
[PrintTestPage] CHECK_EXISTS result exists=false exit_code=Some(0) stdout=""
[PrintTestPage] ERROR step=CHECK_EXISTS message=打印机不存在或未连接: 不存在的打印机
```

## 验收标准

✅ **重新运行应用，触发一次"打印测试页"**

无论成功失败，后端控制台都能看到：
1. ✅ Command 入口的入参日志（包含可见字符和长度）
2. ✅ 每个步骤的 step 标识日志
3. ✅ 完整的 PowerShell 脚本（多行和单行版本）
4. ✅ PowerShell 执行的 exit code、stdout、stderr
5. ✅ 临时文件路径、大小、前 16 字节 hex
6. ✅ 失败时明确的 step 标识和错误信息

## 使用调试开关

如果需要保留临时文件进行排查：

```powershell
# 在 PowerShell 中设置环境变量
$env:EPRINTY_DEBUG_KEEP_TESTPAGE_FILE="1"

# 然后运行应用
# 临时文件将保留在 %TEMP%\printer_test_{PID}.txt
```

## 注意事项

1. 所有日志都输出到 `stderr`（通过 `eprintln!`），不会影响正常返回值
2. stdout/stderr 内容超过 4KB 时会截断，但会显示总长度
3. 错误返回格式统一，前端可以解析 step 标识
4. 不改变原有架构和实现方案，只增加可观测性

## 下一步

根据日志输出，可以精确定位失败发生在哪一步，然后针对性地修复问题。

