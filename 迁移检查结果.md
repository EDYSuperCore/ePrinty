# Windows 安装代码迁移检查结果

## 一、差异对比（Diff）

### main.rs 中的 install_printer 函数变化

#### 迁移前（旧版本）
```rust
#[tauri::command]
async fn install_printer(name: String, path: String) -> Result<InstallResult, String> {
    #[cfg(windows)]
    {
        // 约 330+ 行 Windows 安装代码
        // 包含：
        // - get_windows_build_number() 函数
        // - rundll32 删除旧打印机
        // - powershell Add-PrinterPort 命令
        // - powershell Add-Printer 命令
        // - VBS 脚本执行
        // - 错误处理和重试逻辑
        // ...
    }
}
```

#### 迁移后（当前版本）
```rust
#[tauri::command]
#[allow(non_snake_case)]
async fn install_printer(
    name: String, 
    path: String, 
    driverPath: Option<String>,
    model: Option<String>
) -> Result<InstallResult, String> {
    // 参数校验
    if name.trim().is_empty() {
        return Err("打印机名称不能为空".to_string());
    }
    
    // 调用平台统一的安装入口
    crate::platform::install_printer(name, path, driverPath, model).await
}
```

**主要变化**:
- ✅ 移除了约 330+ 行 Windows 安装实现代码
- ✅ 简化为 17 行（参数校验 + 平台调用）
- ✅ 增加了 `driverPath` 和 `model` 参数支持
- ✅ 所有安装逻辑已迁移到 `platform/windows/install.rs`

### 代码迁移位置

| 功能模块 | 迁移前位置 | 迁移后位置 |
|---------|-----------|-----------|
| `install_printer` 实现 | `main.rs` (330+ 行) | `platform/windows/install.rs` (499 行) |
| `get_windows_build_number` | `main.rs` | `platform/windows/install.rs` |
| Windows 版本检测 | `main.rs` | `platform/windows/install.rs` |
| PowerShell 安装命令 | `main.rs` | `platform/windows/install.rs` |
| VBS 脚本处理 | `main.rs` | `platform/windows/install.rs` |
| 平台统一入口 | 无 | `platform/mod.rs` |

---

## 二、关键字检查结果

### 检查范围
检查 `main.rs` 中是否仍存在以下 Windows 安装相关的关键字：
- `powershell`（用于安装）
- `Add-Printer`（PowerShell 命令）
- `pnputil`（驱动安装工具）
- `rundll32`（打印机管理）

### 详细检查结果

#### 1. powershell

**检查结果**: ⚠️ **部分保留**（但非安装用途）

**在 main.rs 中的位置**:
- **第 35-36 行**: 常量定义（注释说明，未实际使用）
  ```rust
  // PowerShell 命令执行超时时间（秒）
  const POWERSHELL_TIMEOUT_SECS: u64 = 120; // 2分钟，用于打印机安装相关命令
  ```
  - **状态**: 仅常量定义，未在 main.rs 中使用

- **第 80-82 行**: 类型定义中的注释
  ```rust
  struct InstallResult {
      method: Option<String>, // 安装方式："VBS" 或 "Add-Printer"
      stdout: Option<String>,  // PowerShell 标准输出
      stderr: Option<String>,  // PowerShell 错误输出
  }
  ```
  - **状态**: 仅类型定义注释，非实际代码

- **第 555 行**: `print_test_page` 函数中
  ```rust
  let check_output = Command::new("powershell")
  ```
  - **状态**: ✅ **非安装功能** - 用于检查打印机是否存在（测试页功能）

- **第 675 行**: `print_test_page` 函数中
  ```rust
  let output = Command::new("powershell")
  ```
  - **状态**: ✅ **非安装功能** - 用于执行打印测试页命令

- **第 704 行**: `print_test_page` 函数中
  ```rust
  let output2 = Command::new("powershell")
  ```
  - **状态**: ✅ **非安装功能** - 用于备选打印测试页方法

**结论**: ✅ **安装相关的 powershell 调用已完全迁移**
- 所有用于**安装打印机**的 `powershell` 调用已迁移到 `platform/windows/install.rs`
- main.rs 中仅保留用于**打印测试页**的 `powershell` 调用（独立功能，非安装相关）

---

#### 2. Add-Printer

**检查结果**: ✅ **已迁移**（仅保留类型注释）

**在 main.rs 中的位置**:
- **第 80 行**: 类型定义中的注释
  ```rust
  method: Option<String>, // 安装方式："VBS" 或 "Add-Printer"
  ```
  - **状态**: 仅类型定义注释，非实际代码

**在 platform/windows/install.rs 中的位置**:
- **第 198 行**: PowerShell 命令字符串中包含 `Add-PrinterPort`
- **第 302 行**: PowerShell 命令字符串中包含 `Add-Printer`
- **第 403 行**: PowerShell 命令字符串中包含 `Add-Printer`

**结论**: ✅ **已完全迁移**
- 所有实际的 `Add-Printer` PowerShell 命令调用已迁移到 `platform/windows/install.rs`
- main.rs 中仅保留类型定义中的注释引用

---

#### 3. pnputil

**检查结果**: ❌ **未找到**

**搜索范围**: 整个 `main.rs` 文件

**结论**: ✅ **无变化**
- 代码中从未使用 `pnputil` 工具
- 迁移前后均不存在

---

#### 4. rundll32

**检查结果**: ✅ **已完全迁移**

**在 main.rs 中的位置**: ❌ **未找到**

**在 platform/windows/install.rs 中的位置**:
- **第 170 行**: 用于删除旧打印机
  ```rust
  let _ = Command::new("rundll32")
      .args([
          "printui.dll,PrintUIEntry",
          "/dl",  // 删除本地打印机
          "/n",   // 打印机名称
          &format!("\"{}\"", name),
          "/q"    // 静默模式
      ])
  ```

**结论**: ✅ **已完全迁移**
- `rundll32` 调用已从 main.rs 完全移除
- 已迁移到 `platform/windows/install.rs` 第 170 行

---

## 三、总结

### ✅ 迁移成功确认

| 关键字 | 迁移前状态 | 迁移后状态 | 结论 |
|--------|-----------|-----------|------|
| **powershell**（安装相关） | ✅ 存在于安装代码 | ❌ 已移除 | ✅ **已迁移** |
| **powershell**（测试页） | ✅ 存在 | ✅ 保留 | ✅ **合理保留**（非安装功能） |
| **Add-Printer** | ✅ 存在于安装代码 | ⚠️ 仅类型注释 | ✅ **已迁移** |
| **pnputil** | ❌ 不存在 | ❌ 不存在 | ✅ **无变化** |
| **rundll32** | ✅ 存在于安装代码 | ❌ 已移除 | ✅ **已迁移** |

### 最终结论

✅ **迁移成功**: 
- 所有 Windows **安装相关**的关键字和代码已从 `main.rs` 完全移除
- 代码已成功迁移到 `platform/windows/install.rs`
- main.rs 中仅保留：
  1. 简单的包装函数（17 行）
  2. 类型定义（包含注释）
  3. 打印测试页功能（独立功能，非安装相关）

### 迁移后的代码结构

```
src-tauri/src/
├── main.rs                          # 主文件（简化后，无安装实现）
│   ├── install_printer()            # 仅包装函数（17 行）
│   └── print_test_page()            # 测试页功能（保留，非安装）
│
└── platform/
    ├── mod.rs                       # 平台统一入口
    └── windows/
        ├── mod.rs                   # Windows 模块入口
        └── install.rs               # Windows 安装实现（499 行）
            ├── install_printer_windows()
            ├── get_windows_build_number()
            ├── powershell 命令调用
            ├── Add-PrinterPort 命令
            ├── Add-Printer 命令
            └── rundll32 调用
```

---

**检查完成时间**: 2024年
**检查文件**: `src-tauri/src/main.rs`
**迁移目标**: `src-tauri/src/platform/windows/install.rs`

